/*! Ajax File Upload Plugin - v1.0.0 - 2013-02-05
* https://github.com/jchild3rs/AjaxFileUpload
* Copyright (c) 2013 James Childers; Licensed MIT */
(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};window.AjaxFileUploadFlashProxy=function(e,t,n){var r;return console.log(e,t,n),r=window.AjaxFileUpload.instances[e],r.settings[t].apply(r,n)},e=function(){function n(r,i){var s=this;this.input=r,this.iframeUpload=t(this.iframeUpload,this),this.handleAjaxProgressStart=t(this.handleAjaxProgressStart,this),this.handleAjaxProgress=t(this.handleAjaxProgress,this),this.handleAjaxProgressLoad=t(this.handleAjaxProgressLoad,this),this.handleAjaxStateChange=t(this.handleAjaxStateChange,this),this.ajaxUpload=t(this.ajaxUpload,this),this.handleFileSelection=t(this.handleFileSelection,this),this.embedSWF=t(this.embedSWF,this),this.upload=t(this.upload,this);if(this.input===null||this.utils.validate.inputType(this.input.type===!1))return;this.settings=this.utils.merge(e,i),this.input.multiple&&(this.settings.multiple=!0),this.instanceId=this.input.id,this.settings.url===""&&(this.settings.url=this.input.getAttribute("data-url")),this.settings.url===""&&this.input.form.action!==""&&(this.settings.url=this.input.form.action);if(this.settings.url==="")return;this.settings.additionalData!=={}&&(this.settings.url+="?"+this.utils.serialize(this.settings.additionalData)),this.utils.bindEvent(this.input,"change",function(e){return s.handleFileSelection(e,s)}),window.AjaxFileUpload.instances=n.instances||[],window.AjaxFileUpload.instances[this.instanceId]=this}var e;return e={url:"",additionalData:{},autoUpload:!0,dataType:"json",method:"post",pathToSwf:"/dist/AjaxFileUpload.swf",debug:!0,multiple:!1,onSuccess:function(){},onError:function(){},onFileSelect:function(){},onProgress:function(){},onProgressStart:function(){},onProgressEnd:function(){}},n.prototype.upload=function(){return this.utils.has.ajaxUpload?this.ajaxUpload(this):this.iframeUpload(this)},n.prototype.embedSWF=function(){var e,t,n,r,i,s,o,u,a,f;a=this.settings,r=this.input,t=document.getElementById("fu-embed"),t||(t=document.createElement("embed")),s=document.getElementById("fu-object"),s||(s=document.createElement("object")),this.utils.attr(s,{classid:"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",id:"fu-object",align:"left"}),n={id:this.instanceId,url:a.url,method:a.method,debug:a.debug,multiple:a.multiple},u={movie:a.pathToSwf,quality:"low",play:"true",loop:"true",wmode:"transparent",scale:"noscale",menu:"true",devicefont:"false",salign:"",allowScriptAccess:"sameDomain",flashvars:this.utils.serialize(n)};for(i in u)f=u[i],o=document.createElement("param"),this.utils.attr(o,{name:i,value:f}),s.appendChild(o);e={src:a.pathToSwf,id:"fu-embed",name:"fu-embed",classid:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",FlashVars:this.utils.serialize(n),width:r.offsetWidth+5,height:r.offsetHeight+5,style:"position: absolute"},this.utils.attr(t,this.utils.merge(e,u)),s.appendChild(t),r.parentNode.insertBefore(s,r.nextSibling)},n.prototype.handleFileSelection=function(e){var t;return this.settings.autoUpload&&this.upload(),(t=this.settings).onFileSelect.apply(t,[e.target])},n.prototype.ajaxUpload=function(){var e,t,n,r,i=this;this.xhr=new XMLHttpRequest,this.xhr.upload?(this.xhr.upload.addEventListener("progress",function(e){return i.handleAjaxProgress(e)},!1),this.xhr.upload.addEventListener("loadstart",function(e){return i.handleAjaxProgressStart(e)},!1),this.xhr.upload.addEventListener("load",function(e){return i.handleAjaxProgressLoad(e)},!1)):this.xhr.addEventListener("progress",function(e){return i.handleAjaxProgress(e)},!1),this.xhr.addEventListener("readystatechange",function(e){return i.handleAjaxStateChange(e)},!1),this.utils.has.formData&&(this.formData=new FormData),r=this.input.files;for(t=0,n=r.length;t<n;t++)e=r[t],this.formData.append(e.name,e);this.xhr.open(this.settings.method,this.settings.url,!0);switch(this.settings.dataType){case"json":this.xhr.setRequestHeader("Accept","application/json");break;case"xml":this.xhr.setRequestHeader("Accept","text/xml");break;default:}return this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),this.xhr.send(this.formData)},n.prototype.handleAjaxStateChange=function(e){var t,n,r;if(this.xhr.readyState!==4)return;t=this.xhr.responseText,~this.xhr.getResponseHeader("content-type").indexOf("application/json")&&(t=JSON.parse(t)),this.xhr.status===200||this.xhr.status===201?(n=this.settings).onSuccess.apply(n,[t,this.input.files,this.xhr]):(r=this.settings).onError.apply(r,[t,this.input.files,this.xhr])},n.prototype.handleAjaxProgressLoad=function(e){var t;return(t=this.settings).onProgressEnd.apply(t,[e,this.input.files,this.xhr])},n.prototype.handleAjaxProgress=function(e){var t;return(t=this.settings).onProgress.apply(t,[e,this.input.files,this.xhr])},n.prototype.handleAjaxProgressStart=function(e){var t;return(t=this.settings).onProgressStart.apply(t,[e,this.input.files,this.xhr])},n.prototype.iframeUpload=function(e){var t,n,r=this;return this.utils.attr(this.input.form,{action:this.settings.url,target:"fu-iframe",method:this.settings.method,enctype:"multipart/form-data",encoding:"multipart/form-data"}),t=document.getElementById("fu-iframe"),t==null&&(t=document.createElement("iframe")),this.utils.attr(t,{id:"fu-iframe",name:"fu-iframe",style:"display:none"}),this.utils.bindEvent(t,"load",function(){var e,n,r,i,s;return t=window.frames["fu-iframe"],t.document.body.children.length>0||t.document.body.children.length===1?n=t.document.body.children[0].innerHTML:n=t.document.body.innerHTML,n!=null?(e=JSON.parse(n),(r=this.settings).onProgressEnd.apply(r,[e,this.input.files,this.xhr]),(i=this.settings).onSuccess.apply(i,[e,this.input.value,this.xhr])):(s=this.settings).onError.apply(s,[null,this.input.value,this.xhr])}),this.utils.bindEvent(t,"error",function(){var e,t,n;window.frames["fu-iframe"].document.body.children.length>0?t=window.frames["fu-iframe"].document.body.children[0].innerHTML:t=window.frames["fu-iframe"].document.body.innerHTML,e=JSON.parse(t),(n=r.settings).onError.apply(n,[e,r.input.value,r.xhr])}),document.getElementById("fu-iframe")||document.body.appendChild(t),this.input.form.submit(),(n=this.settings).onProgressStart.apply(n,[event,this.input.files,this.xhr])},n.prototype.utils={attr:function(e,t){var n,r,i;i=[];for(n in t)r=t[n],n==="class"&&(n="className"),i.push(e.setAttribute(n,r));return i},serialize:function(e,t){var n,r,i,s;i=[];for(r in e)s=e[r],n=t?t+"["+r+"]":r,typeof s=="object"?i.push(this.utils.serialize(s,n)):i.push(encodeURIComponent(n)+"="+encodeURIComponent(s));return i.join("&")},merge:function(e,t){var n;for(n in t)try{t[n].constructor===Object?e[n]=this.utils.merge(e[n],t[n]):e[n]=t[n]}catch(r){e[n]=t[n]}return e},has:{formData:!!window.FormData,fileAPI:!!window.File&&!!window.FileReader&&!!window.FileList&&!!window.Blob,ajaxUpload:!!window.XMLHttpRequestUpload},bindEvent:function(e,t,n,r){return!r||(r=!0),typeof e.addEventListener!="undefined"?e.addEventListener(t,n,r):e.attachEvent("on"+t,n)},triggerEvent:function(e,t){if((e[t]||!1)&&typeof e[t]=="function")return e[t](e)},validate:{inputType:function(e){return e==="file"},fileName:function(e){return e!==""}}},n}(),window.jQuery&&(jQuery.ajaxFileUpload=e,jQuery.fn.ajaxFileUpload=function(t){return this.each(function(n,r){new e(r,t)})}),typeof define=="function"&&define.amd&&define("ajaxFileUpload",[],function(){return e}),window.AjaxFileUpload=e}).call(this);