/*! Ajax File Upload Plugin - v1.0.0 - 2013-02-10
* https://github.com/jchild3rs/AjaxFileUpload
* Copyright (c) 2013 James Childers; Licensed MIT */
(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=function(){function o(i,s){this.input=i,this.embedSWF=t(this.embedSWF,this),this.handleAjaxProgressEnd=t(this.handleAjaxProgressEnd,this),this.handleAjaxProgress=t(this.handleAjaxProgress,this),this.handleAjaxProgressStart=t(this.handleAjaxProgressStart,this),this.handleAjaxStateChange=t(this.handleAjaxStateChange,this),this.ajaxUpload=t(this.ajaxUpload,this),this.handleFileSelection=t(this.handleFileSelection,this);if(this.input===null||this.input.type!=="file")return;this.settings=r.merge(e,s);if(this.input.multiple||this.settings.multiple)this.input.multiple=!0,this.settings.multiple=!0;this.settings.url===""&&(this.settings.url=this.input.getAttribute("data-url")),this.settings.url===""&&this.input.form.action!==""&&(this.settings.url=this.input.form.action);if(this.settings.url==="")return;this.settings.additionalData!=={}&&(this.settings.url+="?"+r.serialize(this.settings.additionalData)),n.fileAPI&&n.ajaxUpload?this.input.addEventListener("change",this.handleFileSelection):this.embedSWF(),window.AjaxFileUpload.instances=o.instances||[],window.AjaxFileUpload.instances[this.input.id]=this}var e,n,r,i,s;return e={url:"",additionalData:{},autoUpload:!0,dataType:"json",method:"post",pathToSwf:"/dist/AjaxFileUpload.swf",debug:!1,multiple:!1,sizeLimit:0,allowedTypes:"",onSuccess:function(){},onError:function(){},onFileSelect:function(){},onProgress:function(){},onProgressStart:function(){},onProgressEnd:function(){}},o.prototype.handleFileSelection=function(e){var t;s(e.target.files,this.settings)&&(this.settings.autoUpload&&this.ajaxUpload(),(t=this.settings).onFileSelect.apply(t,[e.target.files]))},o.prototype.ajaxUpload=function(){var e,t,n,r,i,s;n=new XMLHttpRequest,n.upload?(n.upload.addEventListener("progress",this.handleAjaxProgress,!1),n.upload.addEventListener("loadstart",this.handleAjaxProgressStart,!1),n.upload.addEventListener("load",this.handleAjaxProgressEnd,!1)):n.addEventListener("progress",this.handleAjaxProgress,!1),n.addEventListener("readystatechange",this.handleAjaxStateChange,!1),t=new FormData,s=this.input.files;for(r=0,i=s.length;r<i;r++)e=s[r],t.append(e.name,e);n.open(this.settings.method,this.settings.url,!0);switch(this.settings.dataType){case"json":n.setRequestHeader("Accept","application/json");break;case"xml":n.setRequestHeader("Accept","text/xml");break;default:}n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.send(t)},o.prototype.handleAjaxStateChange=function(e){var t,n,r,i;n=e.target;if(n.readyState!==4)return;t=n.responseText,~n.getResponseHeader("content-type").indexOf("application/json")&&!!window.JSON&&(t=JSON.parse(t)),n.status===200||n.status===201?(r=this.settings).onSuccess.apply(r,[t,this.input.files,n]):(i=this.settings).onError.apply(i,[t,this.input.files,n])},o.prototype.handleAjaxProgressStart=function(e){var t;return(t=this.settings).onProgressStart.apply(t,[this.input.files,e.target])},o.prototype.handleAjaxProgress=function(e){var t;return(t=this.settings).onProgress.apply(t,[e.loaded,e.total,this.input.files,e.target])},o.prototype.handleAjaxProgressEnd=function(e){var t;return(t=this.settings).onProgressEnd.apply(t,[this.input.files,e.target])},o.prototype.embedSWF=function(){var e,t,n,i,s,o,u,a;n={id:this.input.id,url:this.settings.url,method:this.settings.method,debug:this.settings.debug,multiple:this.settings.multiple,additionalData:this.settings.additionalData,sizeLimit:this.settings.sizeLimit,allowedTypes:this.settings.allowedTypes},u={movie:this.settings.pathToSwf,quality:"low",play:"true",loop:"true",wmode:"transparent",scale:"noscale",menu:"true",devicefont:"false",salign:"",allowScriptAccess:"sameDomain",flashvars:r.serialize(n)},e={src:this.settings.pathToSwf,id:"fu-embed-"+this.input.id,name:"fu-embed-"+this.input.id,classid:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",FlashVars:r.serialize(n),width:this.input.offsetWidth+5,height:this.input.offsetHeight+5,style:"position: absolute"},t=document.getElementById("fu-embed-"+this.input.id),t||(t=document.createElement("embed")),s=document.getElementById("fu-object-"+this.input.id),s||(s=document.createElement("object")),r.attr(s,{classid:"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",id:"fu-object-"+this.input.id,align:"left"});for(i in u)a=u[i],u.hasOwnProperty(i)&&(o=document.createElement("param"),r.attr(o,{name:i,value:a}),s.appendChild(o));r.attr(t,r.merge(e,u)),s.appendChild(t),this.input.parentNode.insertBefore(s,this.input.nextSibling)},r={attr:function(e,t){var n,r;for(n in t)r=t[n],t.hasOwnProperty(n)&&(n==="class"&&(n="className"),e.setAttribute(n,r))},serialize:function(e,t){var n,i,s,o;s=[];for(i in e)o=e[i],n=t?t+"["+i+"]":i,typeof o=="object"?s.push(r.serialize(o,n)):s.push(encodeURIComponent(n)+"="+encodeURIComponent(o));return s.join("&")},merge:function(e,t){var n;for(n in t)try{t[n].constructor===Object?e[n]=r.merge(e[n],t[n]):e[n]=t[n]}catch(i){e[n]=t[n]}return e}},n={fileAPI:!!window.File&&!!window.FileReader&&!!window.FileList&&!!window.Blob,ajaxUpload:!!window.XMLHttpRequestUpload},i={sizeLimit:function(e,t){return e<=t},fileType:function(e,t){var n,r,i,s,o;n=!1;if(!!t){e=e.split("/")[1],r=t.toString().replace(/\*/g,"").split(";");for(s=0,o=r.length;s<o;s++)i=r[s],~i.indexOf(e)&&(n=!0)}return n}},s=function(e,t){var n,r,s,o;r=[];if(e.length===0)return t.onError.apply(this,["No file selected"]),!1;for(s=0,o=e.length;s<o;s++)n=e[s],i.sizeLimit(n.size,t.sizeLimit)||r.push('"'+n.name+'" is '+n.size+" bytes. Your provided limit is "+t.sizeLimit),i.fileType(n.type,t.allowedTypes)||r.push('"'+n.name.split(".")[1]+'" is not a valid file type/extension: '+t.allowedTypes);return r.length>0&&t.onError.apply(this,r),r.length===0},o}(),window.AjaxFileUploadFlashProxy=function(e,t,n){var r;r=window.AjaxFileUpload.instances[e],r.settings[t].apply(r,n)},window.AjaxFileUpload=e,window.jQuery&&(jQuery.ajaxFileUpload=e,jQuery.fn.ajaxFileUpload=function(t){return this.each(function(n,r){new e(r,t)})}),typeof define=="function"&&define.amd&&define("ajaxFileUpload",[],function(){return e})}).call(this);