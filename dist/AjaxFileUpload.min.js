/*! Ajax File Upload Plugin - v0.1.0 - 2013-01-31
* https://github.com/jchild3rs/AjaxFileUpload
* Copyright (c) 2013 James Childers; Licensed MIT */
(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=function(){function r(n,r){this.input=n,this.iframeUpload=t(this.iframeUpload,this),this.handleAjaxProgressStart=t(this.handleAjaxProgressStart,this),this.handleAjaxProgress=t(this.handleAjaxProgress,this),this.handleAjaxProgressLoad=t(this.handleAjaxProgressLoad,this),this.handleAjaxStateChange=t(this.handleAjaxStateChange,this),this.ajaxUpload=t(this.ajaxUpload,this),this.upload=t(this.upload,this),this.handleFileSelection=t(this.handleFileSelection,this);if(this.input===null||this.utils.validate.inputType(this.input.type===!1))return;this.settings=this.utils.merge(e,r),this.settings.additionalData!=={}&&(this.settings.url+="?"+this.utils.serialize(this.settings.additionalData)),this.settings.url===""&&(this.settings.url=this.input.getAttribute("data-url")),this.settings.url===""&&this.input.form.action!==""&&(this.settings.url=this.input.form.action);if(this.settings.url==="")return;this.utils.bindEvent(this.input,"change",this.handleFileSelection),this.xhr=new XMLHttpRequest,this.utils.has.formData&&(this.formData=new FormData)}var e,n=this;return e={url:"",additionalData:{},autoUpload:!0,namespace:"",sizeLimit:1e6,onSuccess:function(){},onError:function(){},onFileSelect:function(){},onProgress:function(){},onProgressStart:function(){},onProgressEnd:function(){}},r.prototype.handleFileSelection=function(e){this.settings.autoUpload&&this.upload(),this.settings.onFileSelect.apply(this,[e.target])},r.prototype.upload=function(){this.utils.has.ajaxUpload?this.ajaxUpload():this.iframeUpload()},r.prototype.ajaxUpload=function(){var e,t,n,r;this.xhr.upload?(this.xhr.upload.addEventListener("progress",this.handleAjaxProgress,!1),this.xhr.upload.addEventListener("loadstart",this.handleAjaxProgressStart,!1),this.xhr.upload.addEventListener("load",this.handleAjaxProgressLoad,!1)):this.xhr.addEventListener("progress",this.handleAjaxProgress,!1),this.xhr.addEventListener("readystatechange",this.handleAjaxStateChange,!1),r=this.input.files;for(t=0,n=r.length;t<n;t++)e=r[t],this.formData.append(e.name,e);this.xhr.processData=!1,this.xhr.contentType=!1,this.xhr.open("POST",this.settings.url,!0),this.xhr.send(this.formData)},r.prototype.handleAjaxStateChange=function(e){var t;if(this.xhr.readyState!==4)return;t=JSON.parse(this.xhr.responseText),this.xhr.status===200||this.xhr.status===201?this.settings.onSuccess.apply(this,[t,e.target.files,this.xhr]):this.settings.onError.apply(this,[t,e.target.files,this.xhr])},r.prototype.handleAjaxProgressLoad=function(e){return this.settings.onProgressEnd.apply(this,[e.target,e.target.files,this.xhr])},r.prototype.handleAjaxProgress=function(e){return this.settings.onProgress.apply(this,[e.target,e.target.files,this.xhr])},r.prototype.handleAjaxProgressStart=function(e){return this.settings.onProgressStart.apply(this,[e.target,e.target.files,this.xhr])},r.prototype.iframeUpload=function(){var e,t=this;this.input.form.action=this.settings.url,this.input.form.target="fu-iframe",this.input.form.method="post",this.input.form.enctype="multipart/form-data",this.input.form.encoding="multipart/form-data",e=document.getElementById("fu-iframe"),e===null&&(e=document.createElement("iframe"),e.id="fu-iframe"),e.name="fu-iframe",e.style.display="none",this.utils.bindEvent(e,"load",function(){var e,n;return window.frames["fu-iframe"].document.body.children.length>0?n=window.frames["fu-iframe"].document.body.children[0].innerHTML:n=window.frames["fu-iframe"].document.body.innerHTML,e=JSON.parse(n),t.settings.onSuccess.apply(t,[e,t.input.value,t.xhr])}),this.utils.bindEvent(e,"error",function(){var e,n;window.frames["fu-iframe"].document.body.children.length>0?n=window.frames["fu-iframe"].document.body.children[0].innerHTML:n=window.frames["fu-iframe"].document.body.innerHTML,e=JSON.parse(n),t.settings.onError.apply(t,[e,t.input.value,t.xhr])}),document.getElementById("fu-iframe")===null&&document.body.appendChild(e),this.input.form.submit()},r.prototype.utils={serialize:function(e,t){var n,i,s,o;s=[];for(i in e)o=e[i],n=t?t+"["+i+"]":i,typeof o=="object"?s.push(r.utils.serialize(o,n)):s.push(encodeURIComponent(n)+"="+encodeURIComponent(o));return s.join("&")},merge:function(e,t){var n;for(n in t)try{t[n].constructor===Object?e[n]=this.utils.merge(e[n],t[n]):e[n]=t[n]}catch(r){e[n]=t[n]}return e},has:{formData:window.FormData,fileAPI:window.File&&window.FileReader&&window.FileList&&window.Blob,ajaxUpload:!!window.XMLHttpRequestUpload},bindEvent:function(e,t,n,r){return!r||(r=!0),typeof e.addEventListener!="undefined"?e.addEventListener(t,n,r):e.attachEvent("on"+t,n)},triggerEvent:function(e,t){(e[t]||!1)&&typeof e[t]=="function"&&e[t](e)},validate:{inputType:function(e){return e==="file"},fileName:function(e){return e!==""}}},r}.call(this),window.jQuery&&(jQuery.ajaxFileUpload=e,jQuery.fn.ajaxFileUpload=function(t){return this.each(function(n,r){new e(r,t)})}),typeof define=="function"&&define.amd?define("ajaxFileUpload",[],function(){return e}):window.AjaxFileUpload=e}).call(this);